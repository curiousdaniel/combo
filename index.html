<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AuctionMethod Bidder Sandbox</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --am-blue: #094780;
    --am-orange: #ff4f24;
    --am-pearl: #f5f5f2;
    --text: #111827;
    --muted: #6b7280;
    --card: #ffffff;
  }
  html, body { height: 100%; }
  body { margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--am-pearl); color: var(--text);}
  .topbar { background: var(--am-blue); color: white; }
  .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
  .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
  @media (min-width: 900px) { .row { grid-template-columns: 1fr 1fr 1fr; } }
  .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); padding: 16px; }
  .brand-chip { width: 32px; height: 32px; border-radius: 10px; background: var(--am-orange); }
  .btn { border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 600; }
  .btn-blue { background: var(--am-blue); color: white; }
  .btn-orange { background: var(--am-orange); color: white; }
  .btn-muted { background: #e5e7eb; color: #111827; }
  .input, select, textarea { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; width: 100%; font: inherit; }
  .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; font-weight: 600; }
  .badge-win { background: #dcfce7; color: #166534; }
  .badge-live { background: #fef9c3; color: #854d0e; }
  .badge-dead { background: #fee2e2; color: #991b1b; }
  .bar { height: 8px; border-radius: 6px; background: #e5e7eb; overflow: hidden; }
</style>
</head>
<body>
  <div class="topbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:16px; padding: 10px 16px;">
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="brand-chip"></div>
        <div style="font-weight:700;">AuctionMethod - Bidder Sandbox</div>
      </div>
      <div style="display:flex; align-items:center; gap:12px; font-size:14px;">
        <label style="opacity:.8">Mode</label>
        <select id="modeSelect" class="input" style="width:auto;">
          <option value="SIMU">SIMU - Identical units</option>
          <option value="MISU">MISU - Unique items</option>
        </select>
        <label style="display:flex; align-items:center; gap:6px;" id="xorWrap">
          <input id="xorToggle" type="checkbox"/>
          <span>XOR - one winning bundle per bidder</span>
        </label>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="root"></div>
  </div>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel" data-presets="env,react" data-plugins="syntax-bigint">
    const { useState, useEffect, useMemo, useRef } = React;

    // ---------- Helpers ----------
    function formatMoney(n) {
      if (n == null) return "";
      if (Number.isNaN(n)) return "";
      if (!Number.isFinite(n)) return "∞";
      const rounded = Math.round(n);
      return rounded.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    function nowMs() { return Date.now(); }
    function makeId(prefix="b") { return prefix + "_" + Math.random().toString(36).slice(2,9); }
    function parseChatToBid(text) {
      const spanMatch = text.match(/(\d+)\s*(?:units?|loaders?|items?|pcs?)/i);
      const moneyMatch = text.replace(/[, ]/g, "").match(/\$?([0-9]+(?:\.[0-9]+)?)(k|m)?/i);
      const span = spanMatch ? parseInt(spanMatch[1],10) : undefined;
      let value;
      if (moneyMatch) {
        const base = parseFloat(moneyMatch[1]);
        const mult = moneyMatch[2]?.toLowerCase() === "m" ? 1_000_000 : moneyMatch[2]?.toLowerCase() === "k" ? 1_000 : 1;
        value = Math.round(base * mult);
      }
      return { span, value };
    }
    function parseLotSelection(input) {
      const out=[];
      for (const token of input.split(/[\,\s]+/).filter(Boolean)) {
        const m = token.match(/^(\d+)-(\d+)$/);
        if (m) { const a=+m[1], b=+m[2]; for (let i=Math.min(a,b); i<=Math.max(a,b); i++) out.push(i); }
        else if (/^\d+$/.test(token)) out.push(+token);
      }
      return Array.from(new Set(out));
    }
    function maskFromIdx(indices) { let m=0n; for (const i of indices) m|=(1n<<BigInt(i)); return m; }
    function overlaps(a,b) { return (a & b) !== 0n; }
    function parseCSV(text) {
      const rows=[]; let row=[], cell="", inQ=false; let i=0;
      while (i<text.length) {
        const ch=text[i];
        if (inQ) {
          if (ch === '"') { if (text[i+1] === '"') { cell+='"'; i+=2; continue; } inQ=false; i++; continue; }
          cell+=ch; i++; continue;
        } else {
          if (ch === '"') { inQ=true; i++; continue; }
          if (ch === ',') { row.push(cell.trim()); cell=""; i++; continue; }
          if (ch === '\n' || ch === '\r') { if (ch==='\\r' && text[i+1]==='\\n') i++; row.push(cell.trim()); rows.push(row); row=[]; cell=""; i++; continue; }
          cell+=ch; i++; continue;
        }
      }
      if (cell.length || inQ || row.length) { row.push(cell.trim()); rows.push(row); }
      return rows.filter(r => r.some(c => c.length));
    }

    // ---------- SIMU-OR Engine ----------
    class SimuOrEngine {
      constructor(N) {
        this.N = N;
        this.REV = Array(N+1).fill(0);
        this.lastWin = Array.from({length:N+1},()=>({bidId:null,span:0}));
        this.bids = new Map();
      }
      placeBid(b) {
        this.bids.set(b.id,b);
        const newREV = this.REV.slice();
        const s=b.span, v=b.value;
        for (let x=s;x<=this.N;x++) {
          const threshold=this.REV[x]-this.REV[x-s];
          if (v>threshold) { newREV[x]=v+this.REV[x-s]; this.lastWin[x]={bidId:b.id,span:s}; }
        }
        this.REV = newREV;
      }
      currentWinningBidIds() { const out=[]; let x=this.N; const guard=new Set(); while(x>0){ const lw=this.lastWin[x]; if(!lw||!lw.bidId||lw.span<=0) break; if(guard.has(lw.bidId)) break; out.push(lw.bidId); guard.add(lw.bidId); x-=lw.span; } return out; }
      WL(span) { if(span<1||span>this.N) return Infinity; return this.REV[this.N]-this.REV[this.N-span]; }
      DL(span) { if(span<1||span>this.N) return Infinity; let min=Infinity; for(let i=span;i<=this.N;i++) min=Math.min(min,this.REV[i]-this.REV[i-span]); return min; }
    }

    // ---------- MISU Engine (OR/XOR exact) ----------
    class MisuEngine {
      constructor(items=[], xor=false) { this.items=items; this.bids=new Map(); this.lastWinners=[]; this.lastRevenue=0; this.xor=xor; }
      setItems(items) { this.items=items; this.bids.clear(); this.lastWinners=[]; this.lastRevenue=0; }
      setXor(flag) { this.xor=flag; this.solveAll(); }
      placeBid(b) { this.bids.set(b.id,b); this.solveAll(); }
      solve(pool, forbidMask=0n, bannedBidders=new Set()) {
        const opts = pool.filter(b=>!overlaps(b.itemsMask,forbidMask) && !bannedBidders.has(b.bidderId)).sort((a,b)=>b.value-a.value);
        let bestVal=0; let best=[];
        const seen=new Map();
        const xorFlag=this.xor;
        function dfs(i, used, usedBidders, val, picks) {
          const key = i+"|"+used.toString()+"|"+Array.from(usedBidders).sort().join(',');
          if (seen.has(key) && seen.get(key) >= val) return; seen.set(key,val);
          let ub=val; for(let k=i;k<opts.length;k++) ub+=opts[k].value; if(ub<=bestVal) return;
          if (i>=opts.length) { if (val>bestVal) { bestVal=val; best=picks.slice(); } return; }
          // skip
          dfs(i+1, used, usedBidders, val, picks);
          const o=opts[i];
          if (!overlaps(used,o.itemsMask) && !bannedBidders.has(o.bidderId)) {
            if (!xorFlag || !usedBidders.has(o.bidderId)) {
              const nextUsed = xorFlag ? new Set(usedBidders).add(o.bidderId) : usedBidders;
              dfs(i+1, used|o.itemsMask, nextUsed, val+o.value, picks.concat([o.id]));
            }
          }
        }
        dfs(0,0n,new Set(),0,[]);
        return { value: bestVal, picks: best };
      }
      solveAll() { const pool=Array.from(this.bids.values()); const res=this.solve(pool,0n,new Set()); this.lastRevenue=res.value; this.lastWinners=res.picks; }
      winningIds() { return this.lastWinners; }
      revenue() { return this.lastRevenue; }
      WL_forBid(b) { const pool=Array.from(this.bids.values()); const revBase=this.solve(pool,0n,new Set()).value; const banned=this.xor? new Set([b.bidderId]) : new Set(); const revRest=this.solve(pool,b.itemsMask,banned).value; return revBase - revRest; }
      DL_forBid(b) { const pool=Array.from(this.bids.values()).filter(x => (x.itemsMask & ~b.itemsMask)===0n && (!this.xor || x.bidderId !== b.bidderId)); return this.solve(pool,0n,new Set()).value; }
    }

    // ---------- Embedded CSV ----------
    const PRELOAD_CSV = atob("bG90LHRpdGxlLGltYWdlCjEwMCxEQ0kgRGlzaCBCb3R0b20gMzA0IFN0YWlubGVzcyBUYW5rIDUwMCBVU0csCjEwMSxQcmVjaXNpb24gU3RhaW5sZXNzIDcwMCBMaXRlciBCaW9yZWFjdG9yIDMxNiBTUywKMTAyLElCQyBTdGFpbmxlc3MgMzUwIEdhbGxvbiBUb3RlLAoxMDMsVHJhbnN0b3JlIFN0YWlubGVzcyAzNTAgR2FsbG9uIFRvdGUsCjEwNCwxMDAwIExpdGVyIFZhcmlhYmxlIFN0YWlubGVzcyBXaW5lIFRhbmsgV2l0aCBTdGFuZCwKMTA1LE1pbm94IFN0YWlubGVzcyBWYXJpYWJsZSAxMDAwIExpdGVyIFdpbmUgVGFuaywKMTA2LCgzKSBTdGFpbmxlc3MgNTUgR2FsbG9uIERydW1zLAoxMDcsKDQpIFN0YWlubGVzcyA1NSBHYWxsb24gRHJ1bXMsCjEwOCxTdGFpbmxlc3MgVGFuayAxNTAwIEdhbGxvbnMsCjEwOSw3QkJMIFN0YWlubGVzcyBKYWNrZXRlZCBCcml0ZSBCZWVyIFRhbmssCjExMSxDcmFmdHNtYW4gMSBIUCBBaXIgY29tcHJlc3NvciAxMTBWLAoxMTIsR2FyZG5lci1EZW52ZXIgRWxlY3RyYS1TY3JldyBBaXIgQ29tcHJlc3NvciwKMTEzLE5pdHJvZ2VuL0MwMiBFdmFwb3JhdG9yLVZhcG9yaXpvciBUb3dlciwKMTE0LEcmRCBHbHljb2wgQ2hpbGxlciAxMEhQLAoxMTUsTWljcm9tYXRpYyBHbHljb2wgQ2hpbGxlciAxLzMgSFAsCjExNixJbmR1c3RyaWFsIEhlYXRlciwKMTE3LENvdXNpbnMgU3RyZXRjaCBQYWxsZXQgUmFwcGVyLAoxMTgsUGhvZW5peCBTdHJldGNoIFBhbGxldCBXcmFwcGVyLAoxMTksR3J1bmRmb3MgV2F0ZXIgUHVtcHMgYW5kIENvbnRyb2xzLAoxMjAsUGFubmRvcmYgUHJvZ3Jlc3NpdmUgQ2F2aXR5IFB1bXAsCjEyMSxKb2huc29uIFBvc2l0aXZlIERpc3BsYWNlbWVudCBQdW1wICAzIiwKMTIyLEFtcGNvIENJUCBQdW1wIDNIUCwKMTIzLENoZXJyeSBCdXJyZWxsIFByb2dyZXNzaXZlIENhdml0eSBQdW1wIDEuNSBIcCwKMTI0LExpdmVyYW5pIFJvdGFyeSBMb2JlIFB1bXAgMS4ySHAsCjEyNSxKYWJzY28gRmxleGlibGUgSW1wZWxsZXIgUHVtcCAxSFAsCjEyNixBbWVyaWNyYWZ0IEFpciBCbG93ZXIgMUhwLAoxMjcsKDIpIFZhY3V1bSBQdW1wcywKMTI4LCgzKSBDb25kZW5zYXRlIFB1bXBzLAoxMjksTWFzdGVyZmxleCBQZXJpc3RhbHRpYyBQdW1wIDc1MjktMTAsCjEzMCxEYXJsZXkgRmlyZSBTdXBwcmVzc2lvbiBUYW5rIGFuZCBQdW1wIFN5c3RlbSwKMTMxLEFtcGNvIFBvcnRhYmxlIENlbnRyaWZ1Z2FsIFB1bXAgMS41SFAsCjEzMixNY0NsYWluIE96b25lIFNhbml0emVyLAoxMzMsT01BQyBHcmFwZSBEZXN0ZW1tZXIgQ3J1c2hlciwKMTM0LCgyKSBXaW5lIEJhcnJlbCBUb3BwaW5nIEtlZ3MsCjEzNSxCdW9uIFZpbm8gU3VwZXIgSmV0IFBhZCBXaW5lIEZpbHRlciwKMTM2LDggLSA1IEdhbGxvbiBHbGFzcyBDYXJib3lzIEZlcm1lbnRlcnMsCjEzNywoMikgU3BpZWRlbCAxMCBHYWxsb24gRmVybWVudGVycywKMTM4LEdXIEtlbnQgMjAiIFN0YWlubGVzcyBDYXJ0cmlkZ2UgRmlsdGVyLAoxMzksSVBST1MgU3RhaW5sZXNzIFBsYXRlIEFuZCBGcmFtZSBIZWF0IEV4Y2hhbmdlciwKMTQwLCg2KSAxNSBHYWxsb24gQmFsbCBMb2NrIFN0YWlubGVzcyBLZWdzLAoxNDEsKDIpIDE1IEdhbGxvbiBTdGFpbmxlc3MgQmFsbCBMb2NrIENhcmJvbmF0aW9uIEtlZ3MsCjE0Miw1IEdhbGxvbiBCYWxsIExvY2sgS2VnIGFuZCBCYWxsIExvY2sgTGlkcywKMTQzLCg5KSAyLjk1IFVTRyBTY2hhZWZlciBGcmVzaCBLZWdzLAoxNDQsMTUuNSBHYWxsb24gS2VnZ2xlIGFuZCBNYXNoIFR1biwKMTQ1LE9yYmlzcGhlcmUgMzYyNCBQcm9Ccml4IFBsdXMgU3lzdGVtLAoxNDYsTG90IG9mIFN0YWlubGVzcyBUcmktQ2xhbXAgVmlicmF0aW9uIElzb2xhdGlvbiBQaXBlcywKMTQ3LExvdCBvZiBTdGFpbmxlc3MgV2VsZC1vbiBUcmktQ2xhbXAgRml0dGluZ3MsCjE0OCwyIiBTdGFpbmxlc3MgV2VsZC1vbiBUcmktQ2xhbXAgRml0dGluZ3MvZmVycnVsZXMs");

    function App() {
      const [mode,setMode] = useState("MISU");
      const [xor,setXor] = useState(true);

      // SIMU
      const [units,setUnits] = useState(8);
      const [simu,setSimu] = useState(()=>new SimuOrEngine(8));
      const [mySimu,setMySimu] = useState([]);
      const [simuFeed,setSimuFeed] = useState([]);
      const [span,setSpan] = useState(2);
      const [amount,setAmount] = useState(52000);
      const [autoSim,setAutoSim] = useState(false);
      const [chat,setChat] = useState("Increase my bid: 4 units for $52k");
      const [myId] = useState(()=> "You_" + Math.random().toString(36).slice(2,6));
      const startRef = useRef(nowMs());

      useEffect(()=>{
        const eng=new SimuOrEngine(units); setSimu(eng); setMySimu([]); setSimuFeed([]); setSpan(s=>Math.max(1,Math.min(units,s)));
      },[units]);
      useEffect(()=>{ if(!autoSim||mode!=="SIMU") return; const h=setInterval(simulateExternalSimu,1200); return ()=>clearInterval(h); },[autoSim,mode,simu]);

      function placeSimu(b){ simu.placeBid(b); setSimu(Object.assign(Object.create(Object.getPrototypeOf(simu)),simu)); setSimuFeed(f=>[b,...f].slice(0,200)); }
      function submitSimu(){ if(span<1||span>units||amount<=0) return; const b={ id:makeId("my"), bidderId:myId, span, value:amount, time: nowMs()-startRef.current }; placeSimu(b); setMySimu(x=>[b,...x]); }
      function simulateExternalSimu(){ const s=Math.max(1,Math.min(units,Math.floor(Math.random()*units)+1)); const wl=simu.WL(s); const bump=[500,1000,2500,5000,7500,10000][Math.floor(Math.random()*6)]; const v=Math.max(1000,(Number.isFinite(wl)?wl:0)+bump); placeSimu({ id:makeId("ext"), bidderId:"Bidder_"+Math.random().toString(36).slice(2,6), span:s, value:v, time: nowMs()-startRef.current }); }

      const winnersSimu = useMemo(()=> new Set(simu.currentWinningBidIds()),[simu]);
      const wlSpan=simu.WL(span); const dlSpan=simu.DL(span); const toWL=Math.max(0,(Number.isFinite(wlSpan)?wlSpan:Infinity)+1-amount);
      const revN = simu.REV[Math.min(simu.N,units)] ?? 0;
      function statusForSimu(b){ if(winnersSimu.has(b.id)) return "WINNING"; const dl=simu.DL(b.span); return b.value>=dl? "LIVE":"DEAD"; }
      function parseAndSubmitChat(){ const p=parseChatToBid(chat); if(p.span&&p.value){ setSpan(p.span); setAmount(p.value); submitSimu(); } }

      // MISU
      const [items,setItems] = useState([]);
      const [misu] = useState(()=>new MisuEngine([], true));
      const [misuFeed,setMisuFeed] = useState([]);
      const [sel,setSel] = useState("1,2,3");
      const [bundle,setBundle] = useState(2500);

      useEffect(()=>{
        try {
          const rows = parseCSV(PRELOAD_CSV);
          if (rows.length) {
            const header = rows[0].map(h=>h.toLowerCase()); const data = rows.slice(1);
            const titleIdx = header.findIndex(h=>/title/.test(h)); const imgIdx = header.findIndex(h=>/img|image|url/.test(h));
            const parsed = data.slice(0,48).map((r,i)=>({ id:i, title:(r[titleIdx]??r[0]??`Lot ${i+1}`), img: (imgIdx>=0? r[imgIdx] : "") || undefined }));
            setItems(parsed); misu.setItems(parsed); misu.setXor(xor);
          }
        } catch(e) { console.error("CSV preload error", e); }
      },[]);
      useEffect(()=>{ misu.setItems(items); misu.setXor(xor); setMisuFeed(f=>f.slice()); },[items,xor,misu]);

      function addMisuBidFromSelection(sel, value){
        const idxs = parseLotSelection(sel).map(n=>n-1).filter(i=>i>=0 && i<items.length);
        if (idxs.length===0) return;
        const b = { id:makeId("misu"), bidderId:myId, itemsMask: maskFromIdx(idxs), items: idxs, value, time: nowMs()-startRef.current };
        misu.placeBid(b); setMisuFeed(f=>[b,...f]);
      }
      function simulateExternalMisu(){
        if(items.length===0) return;
        const pick = Math.max(1,Math.min(4,Math.floor(Math.random()*4)+1));
        const pool=[...Array(items.length).keys()]; const idxs=[]; while(idxs.length<pick && pool.length){ const j=Math.floor(Math.random()*pool.length); idxs.push(pool[j]); pool.splice(j,1); }
        const mask=maskFromIdx(idxs); const dummy={ id:"dummy", bidderId:"Bidder_"+Math.random().toString(36).slice(2,6), itemsMask:mask, items:idxs, value:0, time:0 };
        const wl=misu.WL_forBid(dummy); const bump=[200,400,800,1200,2500][Math.floor(Math.random()*5)]; const val=Math.max(100,(Number.isFinite(wl)?wl:0)+bump);
        const b={ id:makeId("ext"), bidderId:dummy.bidderId, itemsMask:mask, items:idxs, value:val, time: nowMs()-startRef.current };
        misu.placeBid(b); setMisuFeed(f=>[b,...f]);
      }
      const misuWinners = misu.winningIds(); const misuRevenue = misu.revenue();

      // Wire topbar controls
      useEffect(()=>{
        const modeSel = document.getElementById('modeSelect'); const xorWrap = document.getElementById('xorWrap'); const xorT = document.getElementById('xorToggle');
        modeSel.value = mode;
        xorWrap.style.display = mode==="MISU" ? "flex" : "none";
        xorT.checked = xor;
        const onMode = (e)=> setMode(e.target.value);
        const onXor = (e)=> setXor(e.target.checked);
        modeSel.addEventListener('change', onMode);
        xorT.addEventListener('change', onXor);
        return ()=>{ modeSel.removeEventListener('change', onMode); xorT.removeEventListener('change', onXor); }
      },[mode,xor]);

      return (
        <div className="row">
          {mode==="SIMU" ? (
            <>
              <div className="card">
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8}}>
                  <div style={{fontWeight:700}}>Wheel Loaders</div>
                  <div style={{fontSize:12, color:'var(--am-blue)'}}>SIMU-OR</div>
                </div>
                <img src="https://images.unsplash.com/photo-1591390240540-65b56a2b5a7a?q=80&w=1600&auto=format&fit=crop" alt="lot" style={{width:'100%', height:160, objectFit:'cover', borderRadius:12}}/>
                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginTop:12}}>
                  <div>
                    <div style={{fontSize:13, color:'var(--muted)'}}>Total units in lot</div>
                    <input className="input" type="number" min="1" max="200" value={units} onChange={e=>setUnits(Math.max(1,Math.min(200,parseInt(e.target.value||"1",10))) )}/>
                  </div>
                  <div style={{display:'flex', alignItems:'flex-end'}}>
                    <button className={"btn " + (autoSim?"btn-blue":"btn-orange")} onClick={()=>setAutoSim(s=>!s)}>{autoSim?"Auto-sim: ON":"Auto-sim: OFF"}</button>
                  </div>
                </div>
                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginTop:12}}>
                  <div><div style={{fontSize:13, color:'var(--muted)'}}>Bid on bundle (units)</div><input className="input" type="number" min="1" max={units} value={span} onChange={e=>setSpan(Math.max(1,Math.min(units,parseInt(e.target.value||"1",10))))}/></div>
                  <div><div style={{fontSize:13, color:'var(--muted)'}}>Your bid (total $)</div><input className="input" type="number" min="0" value={amount} onChange={e=>setAmount(Math.max(0,parseInt(e.target.value||"0",10)))}/></div>
                </div>
                <div style={{marginTop:8, fontSize:14}}>
                  <div style={{display:'flex', justifyContent:'space-between'}}><span style={{color:'var(--muted)'}}>Winning level (WL) for {span}:</span><b>${formatMoney(wlSpan)}</b></div>
                  <div style={{display:'flex', justifyContent:'space-between'}}><span style={{color:'var(--muted)'}}>Deadness level (DL) for {span}:</span><b>${formatMoney(dlSpan)}</b></div>
                  <div style={{marginTop:4, color:'var(--am-blue)'}}>{toWL<=0? "At or above WL - should win if placed now." : "You are $"+formatMoney(toWL)+" below WL."}</div>
                </div>
                <div style={{display:'flex', gap:8, marginTop:12}}>
                  <button className="btn btn-blue" style={{flex:1}} onClick={submitSimu}>Place bid</button>
                  <button className="btn btn-orange" onClick={simulateExternalSimu}>Sim Opp</button>
                </div>
                <div className="card" style={{marginTop:12}}>
                  <div style={{fontSize:13, color:'var(--muted)', marginBottom:6}}>Chat assistant</div>
                  <div style={{display:'flex', gap:8}}>
                    <input className="input" value={chat} onChange={e=>setChat(e.target.value)} placeholder="e.g., 4 units for $52k"/>
                    <button className="btn btn-blue" onClick={parseAndSubmitChat}>Send</button>
                  </div>
                </div>
              </div>

              <div className="card">
                <div style={{fontWeight:700, marginBottom:8}}>Bidder Feedback</div>
                <div style={{display:'grid', gap:6, fontSize:14}}>
                  <div style={{display:'flex', justifyContent:'space-between'}}><span>Total auction revenue (REV[N])</span><b>${formatMoney(revN)}</b></div>
                  <div style={{display:'flex', justifyContent:'space-between'}}><span>Your selection</span><b>{span} units @ ${formatMoney(amount)}</b></div>
                </div>
                <div style={{marginTop:8}}>
                  <div className="bar"><div style={{height:8, width: Math.min(100, Math.max(5, (amount / Math.max(1, Number.isFinite(wlSpan)? wlSpan:1)) * 100)) + '%', background: amount>=wlSpan? '#22c55e' : amount>=dlSpan? '#eab308' : '#ef4444'}}></div></div>
                  <div style={{display:'flex', justifyContent:'space-between', fontSize:12, color:'var(--muted)', marginTop:4}}><span>0</span><span>WL ${formatMoney(wlSpan)}</span></div>
                </div>
                <div style={{marginTop:12}}>
                  <div style={{fontWeight:600, fontSize:14, marginBottom:6}}>My Active Bids</div>
                  <ul style={{listStyle:'none', padding:0, margin:0}}>
                    {mySimu.length===0 && <li style={{color:'#6b7280', padding:'16px 0'}}>No bids yet.</li>}
                    {mySimu.map(b=>{ const s=statusForSimu(b); return (
                      <li key={b.id} style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px 0', borderTop:'1px solid #eee'}}>
                        <div>
                          <div style={{fontWeight:600}}>{b.span} units / ${formatMoney(b.value)}</div>
                          <div style={{fontSize:12, color:'#6b7280'}}>{(b.time/1000).toFixed(1)}s</div>
                        </div>
                        <span className={"badge "+(s==="WINNING"?"badge-win":s==="LIVE"?"badge-live":"badge-dead")}>{s}</span>
                      </li>
                    );})}
                  </ul>
                </div>
              </div>

              <div className="card">
                <div style={{fontWeight:700, marginBottom:8}}>Current Winning Allocation</div>
                {(() => { const ids = simu.currentWinningBidIds(); if (!ids.length) return <div style={{color:'#6b7280'}}>No winners yet - place some bids.</div>;
                  return <ul style={{listStyle:'none', padding:0, margin:0}}>{ids.map(id=>{ const b=simu.bids.get(id);
                    return (<li key={id} style={{display:'flex', justifyContent:'space-between', padding:'8px 0', borderTop:'1px solid #eee'}}>
                      <div><div style={{fontSize:14}}><span style={{fontWeight:600}}>{b.bidderId}</span> · {b.span} units</div><div style={{fontSize:12, color:'#6b7280'}}>bid id {b.id.slice(0,7)}</div></div>
                      <div style={{fontWeight:700}}>${formatMoney(b.value)}</div>
                    </li>);
                  })}</ul>;
                })()}
                <div className="card" style={{marginTop:12, background:'#fafafa'}}>
                  <div style={{fontWeight:600, marginBottom:6}}>Ledger (mock)</div>
                  <div style={{fontSize:14, color:'#6b7280'}}>In production, each bid would emit a chain event and hash to a Fabric ledger.</div>
                  <button className="btn btn-muted" style={{marginTop:8}}>Verify latest block (mock)</button>
                </div>
              </div>
            </>
          ) : (
            <>
              <div className="card">
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8}}>
                  <div style={{fontWeight:700}}>West Auctions - First {items.length} Lots</div>
                  <div style={{fontSize:12, color:'var(--am-blue)'}}>{xor? "MISU-XOR" : "MISU-OR"}</div>
                </div>
                <div style={{fontSize:13, color:'var(--muted)', marginBottom:6}}>CSV is preloaded. Edit below to adjust or paste your own lines (Title | image URL).</div>
                <textarea className="input" style={{height:120}} defaultValue={items.map(it=>(it.title+(it.img? " | "+it.img:""))).join("\n")} onBlur={e=>{ const lines=e.target.value.split(/\n+/).map(s=>s.trim()).filter(Boolean); const arr=lines.map((line,idx)=>{ const [title,img]=line.split(/\s*\|\s*/); return { id:idx, title:title||("Lot "+(idx+1)), img: (img||"").trim()||undefined }; }); setItems(arr.slice(0,48)); }}/>
                <div style={{marginTop:8}}>
                  <div style={{fontSize:13, color:'var(--muted)'}}>Select lots (e.g., 1,3,5-7)</div>
                  <div style={{display:'flex', gap:8, marginTop:6}}>
                    <input className="input" value={sel} onChange={e=>setSel(e.target.value)}/>
                    <input className="input" type="number" min="0" style={{width:120}} value={bundle} onChange={e=>setBundle(Math.max(0,parseInt(e.target.value||"0",10)))}/>
                    <button className="btn btn-blue" onClick={()=>addMisuBidFromSelection(sel,bundle)}>Bid</button>
                    <button className="btn btn-orange" onClick={simulateExternalMisu}>Sim Opp</button>
                  </div>
                  <div style={{fontSize:12, color:'#6b7280', marginTop:6}}>WL(S) = REV(U) - REV(U\S{xor?'; banned bidder':''}) · DL(S) = {xor? 'REV_XOR(S; banned bidder)' : 'REV(S)'} · Winners exact.</div>
                </div>
              </div>

              <div className="card">
                <div style={{fontWeight:700, marginBottom:8}}>Bidder Feedback</div>
                <div style={{display:'grid', gap:6, fontSize:14}}><div style={{display:'flex', justifyContent:'space-between'}}><span>Total auction revenue</span><b>${formatMoney(misuRevenue)}</b></div></div>
                <div style={{marginTop:8, fontSize:14, color:'var(--muted)'}}>Place a bid to see its exact WL/DL and status under {xor? "XOR" : "OR"}.</div>
                <div style={{fontWeight:700, marginTop:12, marginBottom:6}}>My MISU Bids</div>
                <ul style={{listStyle:'none', padding:0, margin:0}}>
                  {misuFeed.map(b=>{ const wl=misu.WL_forBid(b); const dl=misu.DL_forBid(b); const stat = misu.winningIds().includes(b.id)? "WINNING" : (b.value>=dl? "LIVE":"DEAD"); return (
                    <li key={b.id} style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px 0', borderTop:'1px solid #eee'}}>
                      <div>
                        <div style={{fontSize:14}}><span style={{fontWeight:600}}>{b.bidderId===myId? "You": b.bidderId}</span> · lots {b.items.map(i=>i+1).join(", ")} · WL ${formatMoney(wl)} · DL ${formatMoney(dl)}</div>
                        <div style={{fontSize:12, color:'#6b7280'}}>bid id {b.id.slice(0,7)}</div>
                      </div>
                      <div style={{display:'flex', alignItems:'center', gap:8}}><span className={"badge "+(stat==="WINNING"?"badge-win":stat==="LIVE"?"badge-live":"badge-dead")}}>{stat}</span><b>${formatMoney(b.value)}</b></div>
                    </li>
                  );})}
                </ul>
              </div>

              <div className="card">
                <div style={{fontWeight:700, marginBottom:8}}>Lots</div>
                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, maxHeight:460, overflow:'auto'}}>
                  {items.map(it=> (
                    <div key={it.id} style={{border:'1px solid #eee', borderRadius:12, overflow:'hidden'}}>
                      {it.img ? <img src={it.img} alt={it.title} style={{width:'100%', height:96, objectFit:'cover'}}/> : <div style={{height:96, display:'flex', alignItems:'center', justifyContent:'center', fontSize:12, color:'#6b7280'}}>No image</div>}
                      <div style={{padding:8, fontSize:12}}>{it.id+1}. {it.title}</div>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    function Root(){ return <App/>; }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Root/>);

    // Tests
    (function runTests(){
      try {
        console.group("Sandbox tests");
        console.assert(formatMoney(undefined)==="", "formatMoney undefined ok");
        console.assert(formatMoney(null)==="", "formatMoney null ok");
        console.assert(formatMoney(NaN)==="", "formatMoney NaN ok");
        console.assert(formatMoney(Infinity)==="∞", "formatMoney Infinity ok");
        const se=new SimuOrEngine(4);
        se.placeBid({id:"t1", bidderId:"A", span:2, value:100, time:0});
        console.assert(se.REV[2]>=100, "SIMU REV updated");
        console.groupEnd();
      } catch(e) { console.error("Test harness error", e); }
    })();
  </script>
</body>
</html>
